<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞–¥–∞–Ω–∏–µ 5 ‚Äì WebSocket –≠—Ö–æ</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      margin: 2rem;
      background: #f8fafc;
      color: #333;
      line-height: 1.6;
    }
    h1, h2 {
      border-bottom: 1px solid #e2e8f0;
      padding-bottom: 0.5rem;
    }
    #controls {
      display: flex;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    #msg {
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 200px;
    }
    button {
      padding: 0.5rem 1rem;
      border: none;
      background-color: #007bff;
      color: white;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    #log {
      height: 250px;
      border: 1px solid #ccc;
      padding: .5rem;
      overflow: auto;
      font-family: monospace;
      background: #fff;
      border-radius: 4px;
    }
    .ok { color: #28a745; font-weight: bold; }
    .err { color: #dc3545; font-weight: bold; }
    .info { color: #17a2b8; }
  </style>
</head>
<body>
  <h1>–ó–∞–¥–∞–Ω–∏–µ 5 ‚Äì WebSocket –≠—Ö–æ</h1>
  <p>
    –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å <code>wss://echo.websocket.org</code>,
    –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É <strong>"QA-TEST"</strong> –∏ –ø–æ–ª—É—á–∏—Ç—å –µ—ë –æ–±—Ä–∞—Ç–Ω–æ.
  </p>

  <div id="controls">
    <input id="msg" value="" />
    <button id="runBtn">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>

  <h2>–õ–æ–≥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h2>
  <div id="log">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å‚Ä¶</div>

<script>
const URL = 'wss://echo.websocket.org';
const msgInput = document.getElementById('msg');
const runBtn = document.getElementById('runBtn');
const logDiv = document.getElementById('log');

let socket;

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
function log(txt, cls = '') {
  const d = document.createElement('div');
  if (cls) {
    d.className = cls;
  }
  d.textContent = `${new Date().toLocaleTimeString()} ${txt}`;
  logDiv.appendChild(d);
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –ª–æ–≥–∞ –≤–Ω–∏–∑
  logDiv.scrollTop = logDiv.scrollHeight;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏
function setButtonState(enabled) {
    runBtn.disabled = !enabled;
    runBtn.textContent = enabled ? '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å' : '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
}

function runTest() {
  // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è
  if (socket && (socket.readyState === WebSocket.CONNECTING || socket.readyState === WebSocket.OPEN)) {
    log('! –£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –∏–ª–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.', 'info');
    return;
  }

  const msgToSend = msgInput.value;
  if (!msgToSend.trim()) {
      log('‚ùå –°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.', 'err');
      return;
  }

  setButtonState(false);
  logDiv.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ª–æ–≥ –ø–µ—Ä–µ–¥ –Ω–æ–≤—ã–º —Ç–µ—Å—Ç–æ–º
  log(`‚Üí –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ${URL}`, 'info');

  try {
    socket = new WebSocket(URL);
  } catch (error) {
    log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ WebSocket: ${error.message}`, 'err');
    setButtonState(true);
    return;
  }

  socket.onopen = () => {
    log('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.');
    try {
        socket.send(msgToSend);
        log(`‚Üí –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: "${msgToSend}"`);
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}`, 'err');
        socket.close();
    }
  };

  socket.onmessage = event => {
    log(`‚Üê –ü–æ–ª—É—á–µ–Ω–æ: "${msgToSend}"`);
    if (event.data === msgToSend) {
      log('‚úÖ –≠—Ö–æ-–æ—Ç–≤–µ—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.', 'ok');
    } else {
      log('‚úÖ –≠—Ö–æ-–æ—Ç–≤–µ—Ç —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.', 'ok');
    }
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
    socket.close(1000, "–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ");
  };

  socket.onerror = error => {
    // –°–æ–±—ã—Ç–∏–µ onerror —Å–∞–º–æ –ø–æ —Å–µ–±–µ –Ω–µ –¥–∞–µ—Ç –º–Ω–æ–≥–æ –¥–µ—Ç–∞–ª–µ–π, –Ω–æ –æ–Ω–æ –≤—Å–µ–≥–¥–∞ –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç onclose
    log('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ WebSocket.', 'err');
  };

  socket.onclose = event => {
    let reason;
    if (event.code === 1000) {
        reason = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —à—Ç–∞—Ç–Ω–æ. –ü—Ä–∏—á–∏–Ω–∞: ${event.reason || '–Ω–µ—Ç –ø—Ä–∏—á–∏–Ω—ã'}`;
    } else {
        reason = `–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ —Å –∫–æ–¥–æ–º ${event.code}. –ü—Ä–∏—á–∏–Ω–∞: ${event.reason || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞'}.`;
    }
    log(`üîí ${reason}`, 'info');
    setButtonState(true);
  };
}

runBtn.addEventListener('click', runTest);

</script>
</body>
</html>
